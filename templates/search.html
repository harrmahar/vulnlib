{% extends "base.html" %}

{% block title %}Search Results - VulnLib{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>Search Results</h2>
        <!-- VULN: Reflected XSS - query displayed without escaping -->
        {% if query %}
        <p class="text-muted">Showing results for: <strong>{{ query|safe }}</strong></p>
        {% endif %}
    </div>
</div>

<!-- Search Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" action="{{ url_for('search') }}">
            <div class="row g-2">
                <div class="col-md-4">
                    <label for="searchQuery" class="form-label">Search Term</label>
                    <input type="text" class="form-control" id="searchQuery" name="q" 
                           value="{{ request.args.get('q', '') }}" placeholder="Title, author, description...">
                </div>
                <div class="col-md-3">
                    <label for="categoryFilter" class="form-label">Category</label>
                    <select class="form-select" id="categoryFilter" name="category">
                        <option value="">All Categories</option>
                        <option value="Fiction" {{ 'selected' if request.args.get('category') == 'Fiction' }}>Fiction</option>
                        <option value="Non-Fiction" {{ 'selected' if request.args.get('category') == 'Non-Fiction' }}>Non-Fiction</option>
                        <option value="Science" {{ 'selected' if request.args.get('category') == 'Science' }}>Science</option>
                        <option value="History" {{ 'selected' if request.args.get('category') == 'History' }}>History</option>
                        <option value="Technology" {{ 'selected' if request.args.get('category') == 'Technology' }}>Technology</option>
                        <option value="Biography" {{ 'selected' if request.args.get('category') == 'Biography' }}>Biography</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="authorFilter" class="form-label">Author</label>
                    <input type="text" class="form-control" id="authorFilter" name="author" 
                           value="{{ request.args.get('author', '') }}" placeholder="Author name">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Search Results -->
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <span id="resultsCount" class="text-muted">Loading...</span>
            </div>
            <div>
                <select class="form-select form-select-sm" id="sortBy" style="width: auto;">
                    <option value="title">Sort by Title</option>
                    <option value="author">Sort by Author</option>
                    <option value="year">Sort by Year</option>
                    <option value="category">Sort by Category</option>
                </select>
            </div>
        </div>
        
        <div id="searchResults" class="row">
            <!-- Results will be loaded via JavaScript -->
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Search results pagination" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be populated by JavaScript -->
            </ul>
        </nav>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentPage = 1;
const urlParams = new URLSearchParams(window.location.search);
const searchQuery = urlParams.get('q') || '';
const categoryFilter = urlParams.get('category') || '';
const authorFilter = urlParams.get('author') || '';

document.addEventListener('DOMContentLoaded', function() {
    loadSearchResults();
    
    // Handle sort change
    document.getElementById('sortBy').addEventListener('change', function() {
        loadSearchResults();
    });
});

function loadSearchResults(page = 1) {
    const params = new URLSearchParams();
    if (searchQuery) params.append('search', searchQuery);
    if (categoryFilter) params.append('category', categoryFilter);
    if (authorFilter) params.append('author', authorFilter);
    params.append('page', page);
    
    const resultsContainer = document.getElementById('searchResults');
    resultsContainer.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    fetch(`/api/books?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            displayResults(data);
            updatePagination(data);
            document.getElementById('resultsCount').textContent = 
                `Found ${data.total} books (Page ${data.page} of ${data.pages})`;
        })
        .catch(error => {
            console.error('Error loading search results:', error);
            resultsContainer.innerHTML = '<div class="col-12 text-center"><p class="text-danger">Error loading search results</p></div>';
        });
}

function displayResults(data) {
    const container = document.getElementById('searchResults');
    container.innerHTML = '';
    
    if (data.books && data.books.length > 0) {
        data.books.forEach(book => {
            const bookCard = createSearchResultCard(book);
            container.appendChild(bookCard);
        });
    } else {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-search display-4 text-muted"></i>
                <h4 class="mt-3 text-muted">No books found</h4>
                <p class="text-muted">Try adjusting your search criteria</p>
            </div>
        `;
    }
}

function createSearchResultCard(book) {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4 mb-4';
    
    // VULN: Potential for XSS if book data contains malicious content
    const description = book.description ? 
        (book.description.length > 150 ? book.description.substring(0, 150) + '...' : book.description) : 
        'No description available';
    
    col.innerHTML = `
        <div class="card h-100">
            <div class="row g-0">
                <div class="col-4">
                    <div class="d-flex align-items-center justify-content-center bg-light h-100">
                        ${book.cover_url ? 
                            `<img src="${book.cover_url}" class="img-fluid rounded-start" style="max-height: 120px;" alt="${book.title}">` :
                            `<i class="bi bi-book display-6 text-muted"></i>`
                        }
                    </div>
                </div>
                <div class="col-8">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-1">${book.title}</h6>
                        <p class="card-text text-muted mb-1"><small>by ${book.author}</small></p>
                        <p class="card-text"><small>${description}</small></p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-secondary">${book.category || 'Uncategorized'}</span>
                            <span class="badge ${book.available_copies > 0 ? 'bg-success' : 'bg-danger'}">
                                ${book.available_copies}/${book.total_copies} available
                            </span>
                        </div>
                        <div class="mt-2">
                            <a href="/books/${book.id}" class="btn btn-primary btn-sm">
                                <i class="bi bi-eye"></i> Details
                            </a>
                            ${book.available_copies > 0 && '{{ current_user.is_authenticated }}' ? 
                                `<button class="btn btn-success btn-sm" onclick="requestLoan('${book.id}')">
                                    <i class="bi bi-journal-plus"></i> Borrow
                                </button>` : ''
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return col;
}

function updatePagination(data) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (data.pages <= 1) return;
    
    // Previous button
    const prevItem = document.createElement('li');
    prevItem.className = `page-item ${data.page === 1 ? 'disabled' : ''}`;
    prevItem.innerHTML = `<a class="page-link" href="#" onclick="loadSearchResults(${data.page - 1})">Previous</a>`;
    pagination.appendChild(prevItem);
    
    // Page numbers
    const startPage = Math.max(1, data.page - 2);
    const endPage = Math.min(data.pages, data.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const pageItem = document.createElement('li');
        pageItem.className = `page-item ${i === data.page ? 'active' : ''}`;
        pageItem.innerHTML = `<a class="page-link" href="#" onclick="loadSearchResults(${i})">${i}</a>`;
        pagination.appendChild(pageItem);
    }
    
    // Next button
    const nextItem = document.createElement('li');
    nextItem.className = `page-item ${data.page === data.pages ? 'disabled' : ''}`;
    nextItem.innerHTML = `<a class="page-link" href="#" onclick="loadSearchResults(${data.page + 1})">Next</a>`;
    pagination.appendChild(nextItem);
}

function requestLoan(bookId) {
    // Implementation for loan request
    showToast('Feature coming soon!', 'info');
}

function showToast(message, type = 'success') {
    const toastElement = type === 'success' ? 
        document.getElementById('successToast') : 
        document.getElementById('errorToast');
    const messageElement = type === 'success' ? 
        document.getElementById('successMessage') : 
        document.getElementById('errorMessage');
    
    messageElement.textContent = message;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
}
</script>
{% endblock %}